# 统计服务实现文档

## 1. 概述

统计服务基于时间窗口统计服务实现，提供帖子浏览量、首页浏览量、点赞数、收藏数等业务统计功能。支持按小时、按天统计，适用于数据报表、趋势分析、业务分析等场景。

## 2. 业界常见的统计实现方法

### 2.1 数据库统计法
**原理**：将统计数据存储在数据库中，查询时使用 SQL 聚合函数统计。

**特点**：
- ✅ 数据持久化
- ✅ 支持复杂统计
- ❌ 查询性能差（需要聚合计算）
- ❌ 实时性差

**应用场景**：
- 数据量小的场景
- 需要复杂统计的场景

### 2.2 实时统计法（本项目采用）
**原理**：使用 Redis 实时记录统计数据，查询时直接读取。

**特点**：
- ✅ 查询性能高
- ✅ 实时性好
- ⚠️ 需要定期持久化到数据库
- ⚠️ 存储空间较大

**应用场景**：
- 需要实时统计的场景
- 数据量中等的场景

### 2.3 定时计算法
**原理**：定时（如每小时）计算统计数据，将结果缓存。

**特点**：
- ✅ 数据库压力小
- ✅ 查询性能高（预计算）
- ❌ 实时性差（有延迟）
- ❌ 计算资源消耗大

**应用场景**：
- 对实时性要求不高的场景
- 数据量很大的场景

## 3. 本项目的实现方式

### 3.1 数据存储结构

#### 时间窗口统计数据（基于 TimeWindowStatisticsService）
- **帖子浏览量**：`stats:window:post:view:{postId}`
- **首页浏览量**：`stats:window:homepage:view`
- **帖子点赞**：`stats:window:post:like:{postId}`
- **帖子收藏**：`stats:window:post:favorite:{postId}`

**数据结构**：Redis Sorted Set
- **Score**：时间戳（毫秒）
- **Member**：数据值（如 "1" 表示一次浏览）

### 3.2 核心功能实现

#### 3.2.1 记录统计数据
**功能**：记录各种业务统计数据

**实现方式**：
- `recordPostView(postId)`：记录帖子浏览量
- `recordHomePageView(userId)`：记录首页浏览量
- `recordLike(postId, isLike)`：记录点赞（1表示点赞，-1表示取消点赞）
- `recordFavorite(postId, isFavorite)`：记录收藏（1表示收藏，-1表示取消收藏）

**特点**：
- 使用时间窗口统计服务记录数据点
- 支持增减操作（点赞、收藏）

#### 3.2.2 获取统计结果
**功能**：获取各种统计数据

**实现方式**：
- `getPostViewStatistics(postId, hours)`：获取帖子浏览量统计（按小时）
- `getHomePageViewStatistics(hours)`：获取首页浏览量统计（按小时）
- `getLikeStatistics(postId, hours)`：获取点赞统计（按小时，累计值）
- `getFavoriteStatistics(postId, hours)`：获取收藏统计（按小时，累计值）
- `getComprehensiveStatistics(postId, hours)`：获取综合统计

**统计方式**：
- **简单计数**：浏览量等，直接统计数据点数量
- **累计值**：点赞、收藏等，累计计算（1表示增加，-1表示减少）

#### 3.2.3 按日期范围统计
**功能**：获取指定日期范围内的统计数据

**实现方式**：
- `getDailyUVInRange(resourceType, resourceId, startDate, endDate)`：获取每日UV统计
- `getPostStatisticsInRange(postId, startDate, endDate)`：获取帖子综合统计

**统计内容**：
- 每日UV统计
- 每日点赞数统计
- 每日收藏数统计
- 每日评论数统计
- 总量统计
- 增量统计

## 4. 使用场景

### 4.1 数据报表
**场景**：生成数据报表，展示业务数据趋势

**实现**：
```
// 获取最近24小时的浏览量统计
List<Map<String, Object>> viewStats = statisticsService.getPostViewStatistics(postId, 24);
```

### 4.2 趋势分析
**场景**：分析业务数据趋势

**实现**：
```
// 获取最近7天的综合统计
Map<String, Object> stats = statisticsService.getPostStatisticsInRange(
    postId, "20240101", "20240107");
```

### 4.3 业务分析
**场景**：分析业务指标

**实现**：
```
// 获取综合统计
Map<String, Object> comprehensive = statisticsService.getComprehensiveStatistics(postId, 24);
```

## 5. 性能优化

### 5.1 实时统计
- 使用 Redis 实时记录统计数据
- 查询时直接读取，性能高

### 5.2 数据聚合
- 按小时聚合数据，减少数据量
- 支持按日期范围查询

### 5.3 数据持久化
- 定期将统计数据持久化到数据库
- 支持历史数据查询

## 6. 优缺点分析

### 6.1 优点
1. **实时性好**：统计数据实时更新，立即生效
2. **查询性能高**：基于 Redis，查询速度快
3. **支持多维度统计**：支持浏览量、点赞、收藏等多种统计
4. **支持时间范围查询**：支持按小时、按天查询
5. **支持综合统计**：可以获取综合统计数据

### 6.2 缺点
1. **存储空间**：所有统计数据存储在 Redis 中，存储空间较大
2. **数据持久化**：需要定期持久化到数据库
3. **数据聚合**：需要应用层进行数据聚合

## 7. 适用场景

### 7.1 适用场景
- ✅ 需要实时统计的场景
- ✅ 数据量中等的场景（百万级以内）
- ✅ 需要多维度统计的场景
- ✅ 需要时间范围查询的场景

### 7.2 不适用场景
- ❌ 数据量极大的场景（亿级）：建议使用定时计算法
- ❌ 对实时性要求不高的场景：可以使用数据库统计法
- ❌ 需要复杂统计的场景：建议使用专业数据分析工具

## 8. 扩展功能

### 8.1 数据可视化
- 集成图表库，可视化统计数据
- 支持多种图表类型

### 8.2 数据导出
- 支持导出统计数据
- 支持多种格式（CSV、Excel等）

### 8.3 数据告警
- 设置统计阈值
- 超过阈值时发送告警

### 8.4 数据预测
- 基于历史数据预测未来趋势
- 支持多种预测算法


