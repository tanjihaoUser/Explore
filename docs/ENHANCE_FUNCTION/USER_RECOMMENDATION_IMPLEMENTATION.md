# 用户推荐实现文档

## 1. 概述

用户推荐功能使用 Redis Set 实现随机用户推荐，支持候选用户管理、推荐去重、推荐标记等功能。适用于用户推荐、内容推荐、相似用户发现等场景。

## 2. 业界常见的推荐实现方法

### 2.1 协同过滤算法
**原理**：基于用户行为相似性推荐（如用户A和用户B都喜欢内容X，则推荐用户A喜欢的内容给用户B）。

**特点**：
- ✅ 推荐准确度高
- ✅ 适用于冷启动
- ❌ 计算复杂度高
- ❌ 需要大量用户行为数据

**应用场景**：
- 大型内容平台
- 有丰富用户行为数据的场景

### 2.2 内容推荐算法
**原理**：基于内容相似性推荐（如推荐与用户喜欢内容相似的内容）。

**特点**：
- ✅ 推荐准确度高
- ✅ 可解释性强
- ❌ 需要内容特征数据
- ❌ 计算复杂度高

**应用场景**：
- 内容平台
- 有内容特征数据的场景

### 2.3 随机推荐法（本项目采用）
**原理**：从候选用户中随机推荐，避免重复推荐。

**特点**：
- ✅ 实现简单
- ✅ 性能高
- ✅ 支持去重
- ⚠️ 推荐准确度较低

**应用场景**：
- 需要快速上线的场景
- 对推荐准确度要求不高的场景
- 作为其他推荐算法的补充

### 2.4 机器学习推荐
**原理**：使用机器学习模型预测用户兴趣。

**特点**：
- ✅ 推荐准确度高
- ✅ 自适应调整
- ❌ 实现复杂度极高
- ❌ 需要大量数据训练

**应用场景**：
- 大型平台
- 有机器学习团队的场景

## 3. 本项目的实现方式

### 3.1 数据存储结构

#### Redis Set
- **候选用户集合**：`recommend:candidate:{userId}` - 存储候选推荐用户ID
- **已推荐用户集合**：`recommend:shown:{userId}` - 存储已推荐给该用户的用户ID

**示例**：
```
Key: recommend:candidate:123
Set: {456, 789, 101, 202, 303}  (候选用户)

Key: recommend:shown:123
Set: {456, 789}  (已推荐用户)
```

### 3.2 Redis 命令使用

| 命令 | 用途 | 示例 |
|------|------|------|
| `SADD` | 添加候选用户 | `SADD recommend:candidate:123 456` |
| `SRANDMEMBER` | 随机获取用户（不删除） | `SRANDMEMBER recommend:candidate:123` |
| `SPOP` | 随机获取并删除用户 | `SPOP recommend:candidate:123` |
| `SREM` | 移除用户（标记为已推荐） | `SREM recommend:candidate:123 456` |
| `SCARD` | 获取候选用户数量 | `SCARD recommend:candidate:123` |
| `SMEMBERS` | 获取所有成员 | `SMEMBERS recommend:candidate:123` |
| `SDIFF` | 过滤已推荐用户 | `SDIFF candidate:123 shown:123` |

### 3.3 核心功能实现

#### 3.3.1 添加候选用户
**功能**：添加候选推荐用户

**实现方式**：
- `addCandidates(userId, candidateUserIds)`：批量添加候选用户
- 添加到 `recommend:candidate:{userId}` Set 中

**特点**：
- 支持批量添加
- 自动去重（Set 特性）

#### 3.3.2 推荐用户
**功能**：推荐用户给目标用户

**实现方式**：
- `recommendUsers(userId, count)`：推荐用户（不标记）
- `recommendAndMark(userId, count)`：推荐并标记为已推荐

**推荐流程**：
1. 获取候选用户集合
2. 获取已推荐用户集合
3. 过滤已推荐用户（差集运算）
4. 随机选择用户
5. 返回推荐结果

**特点**：
- 自动过滤已推荐用户
- 随机选择，避免重复推荐
- 支持批量推荐

#### 3.3.3 标记已推荐
**功能**：标记用户为已推荐

**实现方式**：
- `markAsRecommended(userId, recommendedUserId)`：标记单个用户
- `markAsRecommendedBatch(userId, recommendedUserIds)`：批量标记

**特点**：
- 支持单个和批量标记
- 标记后不会再次推荐

#### 3.3.4 清理推荐历史
**功能**：清理已推荐历史，允许重新推荐

**实现方式**：
- `clearRecommendedHistory(userId)`：清理已推荐历史
- 删除 `recommend:shown:{userId}` Set

**特点**：
- 清理后可以重新推荐
- 返回清理的用户数量

#### 3.3.5 获取候选数量
**功能**：获取候选用户数量

**实现方式**：
- `getCandidateCount(userId)`：获取候选用户数量
- 使用 `SCARD` 命令

## 4. 使用场景

### 4.1 用户推荐
**场景**：在用户主页推荐可能感兴趣的用户

**实现**：
```
// 添加候选用户
recommendationService.addCandidates(userId, candidateUserIds);

// 推荐用户
List<Long> recommended = recommendationService.recommendUsers(userId, 10);
```

### 4.2 推荐去重
**场景**：避免重复推荐相同用户

**实现**：
```
// 推荐并标记
List<Long> recommended = recommendationService.recommendAndMark(userId, 10);
// 下次推荐时自动过滤已推荐用户
```

### 4.3 重新推荐
**场景**：清理推荐历史，允许重新推荐

**实现**：
```
// 清理推荐历史
recommendationService.clearRecommendedHistory(userId);

// 重新推荐
List<Long> recommended = recommendationService.recommendUsers(userId, 10);
```

## 5. 性能优化

### 5.1 集合运算
- 使用 Redis 的 `SDIFF` 进行差集运算
- 服务器端操作，性能高

### 5.2 随机选择
- 使用 `SPOP` 随机获取并删除，避免重复
- 或使用 `SRANDMEMBER` 随机获取，然后手动标记

### 5.3 批量操作
- 支持批量添加候选用户
- 支持批量标记已推荐

## 6. 优缺点分析

### 6.1 优点
1. **实现简单**：基于 Redis Set，实现简单
2. **性能高**：Redis Set 操作性能 O(1)
3. **支持去重**：自动过滤已推荐用户
4. **支持随机推荐**：随机选择，避免重复
5. **灵活管理**：支持清理推荐历史，重新推荐

### 6.2 缺点
1. **推荐准确度低**：随机推荐，不考虑用户兴趣
2. **需要维护候选池**：需要预先添加候选用户
3. **存储空间**：需要存储候选用户和已推荐用户

## 7. 适用场景

### 7.1 适用场景
- ✅ 需要快速上线的场景
- ✅ 对推荐准确度要求不高的场景
- ✅ 作为其他推荐算法的补充
- ✅ 需要避免重复推荐的场景

### 7.2 不适用场景
- ❌ 需要高准确度推荐的场景：建议使用协同过滤或机器学习算法
- ❌ 需要个性化推荐的场景：建议使用内容推荐算法
- ❌ 候选用户数量极少的场景：推荐效果不佳

## 8. 扩展功能

### 8.1 推荐策略
- 支持多种推荐策略（随机、按活跃度、按相似度等）
- 支持策略组合

### 8.2 推荐权重
- 为候选用户设置权重
- 按权重随机推荐

### 8.3 推荐分析
- 分析推荐效果
- 统计推荐转化率

### 8.4 协同过滤
- 基于用户行为计算相似度
- 推荐相似用户喜欢的内容


