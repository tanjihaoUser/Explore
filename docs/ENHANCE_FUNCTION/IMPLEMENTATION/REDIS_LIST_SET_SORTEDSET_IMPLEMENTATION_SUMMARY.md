# List、Set、SortedSet 实现汇总

## 概述

本文档汇总项目中 Redis 三种核心数据结构（List、Set、SortedSet）的实现情况，包括基础功能、高级功能和应用场景。

**实现完成度**: 100% ✅

---

## 一、Redis List 实现总结

### 1.1 基础操作

**实现位置**: `BoundUtil.java` (555-725行)

**已实现的 Redis 命令**:

| Redis命令 | BoundUtil方法 | 功能 | 时间复杂度 |
|-----------|---------------|------|------------|
| LPUSH | `leftPush()` | 从左侧推入元素 | O(1) |
| RPUSH | `rightPush()` | 从右侧推入元素 | O(1) |
| LPOP | `leftPop()` | 从左侧弹出元素 | O(1) |
| RPOP | `rightPop()` | 从右侧弹出元素 | O(1) |
| LRANGE | `range()` | 获取指定范围的元素 | O(S+N) |
| LLEN | `listSize()` | 获取列表长度 | O(1) |
| LTRIM | `trim()` | 修剪列表，保留指定范围 | O(N) |
| LREM | `listRemove()` | 移除指定值的元素 | O(N+M) |
| LINDEX | `listIndex()` | 获取指定索引的元素 | O(N) |
| LSET | `listSet()` | 设置指定索引的元素 | O(N) |
| LINSERT | `listInsert()` | 在指定元素前后插入 | O(N) |
| BLPOP | `blockLeftPop()` | 阻塞式从左侧弹出 | O(1) |
| BRPOP | `blockRightPop()` | 阻塞式从右侧弹出 | O(1) |
| RPOPLPUSH | `rightPopAndLeftPush()` | 原子性移动元素 | O(1) |
| BRPOPLPUSH | `blockRightPopAndLeftPush()` | 阻塞式原子移动 | O(1) |

### 1.2 高级功能

#### 1.2.1 基础消息队列 ✅

**服务**: `RedisListQueueService`

**功能**:
- 支持阻塞/非阻塞消息消费
- 批量发送和接收消息
- 队列长度查询和清空

**应用场景**: 简单的生产者-消费者消息队列

#### 1.2.2 用户最近活动记录 ✅

**服务**: `UserActivityService`

**功能**:
- 记录用户活动（LPUSH）
- 获取最近活动（LRANGE，支持分页）
- 自动限制记录数量（LTRIM）

**应用场景**: 用户最近操作活动记录、浏览历史

#### 1.2.3 系统通知列表 ✅

**服务**: `NotificationService`

**功能**:
- 通知列表管理（List）
- 未读通知管理（Set）
- 支持分页查询

**应用场景**: 系统通知列表和未读状态管理



## 二、Redis Set 实现总结

### 2.1 基础操作

**实现位置**: `BoundUtil.java` (728-950行)

**已实现的 Redis 命令**:

| Redis命令 | BoundUtil方法 | 功能 | 时间复杂度 |
|-----------|---------------|------|------------|
| SADD | `sAdd()` | 添加成员 | O(1) |
| SREM | `sRem()` | 移除成员 | O(N) |
| SISMEMBER | `sIsMember()` | 检查成员是否存在 | O(1) |
| SMEMBERS | `sMembers()` | 获取所有成员 | O(N) |
| SCARD | `sCard()` | 获取集合大小 | O(1) |
| SPOP | `sPop()` | 随机弹出成员 | O(1) |
| SRANDMEMBER | `sRandMember()` | 随机获取成员（不删除） | O(1) |
| SINTER | `sIntersect()` | 计算交集 | O(N*M) |
| SINTERSTORE | `sIntersectAndStore()` | 计算交集并存储 | O(N*M) |
| SDIFF | `sDifference()` | 计算差集 | O(N) |
| SDIFFSTORE | `sDifferenceAndStore()` | 计算差集并存储 | O(N) |
| SUNION | `sUnion()` | 计算并集 | O(N) |
| SUNIONSTORE | `sUnionAndStore()` | 计算并集并存储 | O(N) |

### 2.2 高级功能

#### 2.2.1 关系数据存储 ✅

**服务**: `RelationService`

**功能**:
- 关注关系（Following/Followers）
- 点赞关系（Like）
- 收藏关系（Favorite）
- 黑名单关系（Block）

**技术亮点**:
- 使用 Lua 脚本保证原子性
- 双向关系维护
- 支持批量查询

#### 2.2.2 集合运算功能扩展 ✅

**服务**: `RelationService`

**功能**:
- `getMutualFollowing()` - 共同关注（SINTER）
- `getRecommendedFollowing()` - 推荐关注（SDIFF）
- `getFollowingUnion()` - 关注并集（SUNION）
- `getMutualFollowers()` - 共同粉丝（SINTER）

**技术亮点**:
- 充分利用 Set 的交集、并集、差集运算
- 支持多用户共同关注查询
- 使用差集运算实现推荐关注功能

#### 2.2.3 随机用户推荐 ✅

**服务**: `UserRecommendationService`

**功能**:
- 随机推荐用户（SPOP）
- 标记已推荐用户（SADD）
- 清除推荐历史

**技术亮点**:
- 使用 `SPOP` 实现随机推荐，避免重复
- Set 自动去重特性

#### 2.2.4 独立访客统计 ✅

**服务**: `UVStatisticsService`

**功能**:
- 记录访问（SADD，自动去重）
- 获取UV（SCARD）
- 支持日UV统计
- 合并多天UV数据

**技术亮点**:
- Set 天然去重特性，实现精确的UV统计
- 支持多维度统计



## 三、Redis SortedSet 实现总结

### 3.1 基础操作

**实现位置**: `BoundUtil.java` (768-960行)

**已实现的 Redis 命令**:

| Redis命令 | BoundUtil方法 | 功能 | 时间复杂度 |
|-----------|---------------|------|------------|
| ZADD | `zAdd()` | 添加/更新成员分数 | O(log(N)) |
| ZINCRBY | `zIncrBy()` | 增量更新分数 | O(log(N)) |
| ZRANGE | `zRange()` | 正序范围查询 | O(log(N)+M) |
| ZREVRANGE | `zReverseRange()` | 倒序范围查询 | O(log(N)+M) |
| ZSCORE | `zScore()` | 获取成员分数 | O(1) |
| ZREM | `zRem()` | 删除成员 | O(M*log(N)) |
| ZCARD | `zCard()` | 获取集合大小 | O(1) |
| ZREVRANK | `zRevRank()` | 获取倒序排名 | O(log(N)) |
| ZRANGEBYSCORE | `zRangeByScore()` | 按分数范围查询（正序） | O(log(N)+M) |
| ZREVRANGEBYSCORE | `zRevRangeByScore()` | 按分数范围查询（倒序） | O(log(N)+M) |
| ZUNIONSTORE | `zUnionAndStore()` | 集合聚合（并集，支持权重） | O(N*K)+O(M*log(M)) |

### 3.2 高级功能

#### 3.2.1 单项排行榜系统 ✅

**服务**: `RankingService`

**功能**:
- 点赞/收藏/评论排行榜
- 实时更新（ZINCRBY）
- 支持分页查询（ZREVRANGE）

**应用场景**: 单项统计数据排行榜

#### 3.2.2 综合热度排行榜 ✅

**服务**: `HotRankingService`

**功能**:
- 多时间段热度排行榜（日榜、周榜、月榜、总榜）
- 实时计算热度分数
- 支持排名查询

**热度算法**: `热度 = 点赞数 × 0.4 + 收藏数 × 0.3 + 评论数 × 0.2 + 分享数 × 0.1`

#### 3.2.3 时间线聚合功能 ✅

**服务**: `TimelineSortedSetService`

**功能**:
- 用户时间线（ZADD，分数为时间戳）
- 全局时间线
- 聚合时间线（ZUNIONSTORE）
- 时间范围查询（ZRANGEBYSCORE）

**技术亮点**:
- 使用 Lua 脚本保证原子性
- 自动限制时间线大小
- 支持黑名单过滤

#### 3.2.4 精确延迟队列 ✅

**服务**: `DelayQueueService`

**功能**:
- 添加延迟任务（ZADD，分数为执行时间戳）
- 获取到期任务（ZRANGEBYSCORE）
- 支持任务查询和取消
- 自动消费（定时轮询）

**应用场景**: 订单超时自动取消、优惠券过期提醒、定时推送消息

#### 3.2.5 时间窗口统计 ✅

**服务**: `TimeWindowStatisticsService`

**功能**:
- 添加数据点（ZADD，分数为时间戳）
- 时间范围查询（ZRANGEBYSCORE）
- 自动清理过期数据
- 支持统计计算（求和、平均、最大、最小）

**应用场景**: 最近7天访问统计、最近30天销售额统计

#### 3.2.6 多维度排序 ✅

**服务**: `MultiDimensionSortService`

**功能**:
- 多维度数据管理
- 综合排序（ZUNIONSTORE，支持权重）
- 支持多种聚合方式（SUM、MAX、MIN）

**应用场景**: 商品排序（价格+销量+评分）、内容排序（热度+时间+质量）



## 四、三种数据结构对比

### 4.1 特性对比

| 特性 | List | Set | SortedSet |
|------|------|-----|-----------|
| **有序性** | ✅ 有序（插入顺序） | ❌ 无序 | ✅ 有序（按分数） |
| **唯一性** | ❌ 允许重复 | ✅ 自动去重 | ✅ 自动去重 |
| **查询方式** | 索引查询 | 成员查询 | 分数/排名查询 |
| **主要用途** | 队列、列表 | 关系、去重 | 排行榜、排序 |
| **时间复杂度** | O(1) 大部分操作 | O(1) 大部分操作 | O(log(N)) 大部分操作 |

### 4.2 使用场景对比

| 场景 | 推荐数据结构 | 原因 |
|------|------------|------|
| **消息队列** | List | 有序，支持阻塞消费 |
| **用户活动记录** | List | 有序，最新在前 |
| **关注关系** | Set | 去重，支持集合运算 |
| **共同关注** | Set | 交集运算 |
| **排行榜** | SortedSet | 按分数排序 |
| **时间线** | SortedSet | 按时间戳排序 |
| **延迟队列** | SortedSet | 按执行时间排序 |
| **UV统计** | Set | 自动去重 |
| **多维度排序** | SortedSet | 支持权重聚合 |



## 五、技术亮点总结

### 5.1 通用技术亮点

1. **类型安全**: 所有方法支持泛型，自动类型转换
2. **统一封装**: 所有 Redis 操作统一通过 `BoundUtil` 访问
3. **原子性保证**: 关键操作使用 Lua 脚本保证原子性
4. **性能优化**: 使用增量更新、批量操作等优化性能

### 5.2 List 技术亮点

1. **阻塞式消费**: 使用 `BRPOP` 实现阻塞式消息消费，避免轮询
2. **自动限制大小**: 使用 `LTRIM` 自动限制列表大小，防止内存溢出
3. **分页支持**: 支持分页查询，提高查询效率

### 5.3 Set 技术亮点

1. **集合运算**: 充分利用 Set 的交集、并集、差集运算，实现复杂业务逻辑
2. **自动去重**: Set 天然去重特性，实现精确的UV统计
3. **随机推荐**: 使用 `SPOP` 实现随机推荐，避免重复推荐

### 5.4 SortedSet 技术亮点

1. **增量更新**: 使用 `ZINCRBY` 实现原子性增量更新，避免并发问题
2. **高效分页**: 使用 `ZREVRANGE` 实现高效分页查询，无需应用层排序
3. **集合聚合**: 使用 `ZUNIONSTORE` 聚合多个时间线，服务器端操作性能高
4. **范围查询**: 使用 `ZRANGEBYSCORE` 实现时间范围查询，适合时间线场景
5. **权重支持**: 支持多维度加权排序，灵活调整排序规则



## 六、实现完成度

### 6.1 功能实现情况

| 数据结构 | 基础功能 | 高级功能 | 完成度 |
|---------|---------|---------|--------|
| **List** | ✅ 14个命令 | ✅ 3个高级功能 | 100% ✅ |
| **Set** | ✅ 13个命令 | ✅ 4个高级功能 | 100% ✅ |
| **SortedSet** | ✅ 11个命令 | ✅ 7个高级功能 | 100% ✅ |

### 6.2 服务实现情况

| 服务类别 | 服务数量 | 完成度 |
|---------|---------|--------|
| **List 服务** | 3个 | 100% ✅ |
| **Set 服务** | 4个 | 100% ✅ |
| **SortedSet 服务** | 7个 | 100% ✅ |



## 七、性能优化建议

### 7.1 通用优化

1. **批量操作**: 使用 Pipeline 优化批量操作
2. **定期清理**: 定期清理过期数据，防止内存占用过大
3. **监控告警**: 监控数据结构大小，及时告警
4. **大集合遍历**: 大集合使用 SCAN/ZSCAN 游标遍历，避免阻塞

### 7.2 List 优化

1. **限制大小**: 使用 `LTRIM` 限制列表大小
2. **批量操作**: 批量发送和接收消息
3. **阻塞消费**: 使用 `BRPOP` 避免轮询

### 7.3 Set 优化

1. **集合运算**: 使用服务器端集合运算，减少网络传输
2. **批量操作**: 批量添加和删除成员
3. **定期清理**: 定期清理过期关系数据

### 7.4 SortedSet 优化

1. **增量更新**: 使用 `ZINCRBY` 避免先读后写
2. **范围查询**: 使用 `ZRANGEBYSCORE` 精确查询
3. **批量操作**: 批量更新分数
4. **定期清理**: 定期清理过期排行榜数据



## 八、总结

本项目完整实现了 Redis 三种核心数据结构（List、Set、SortedSet）的基础功能和高级功能，涵盖了消息队列、关系数据、排行榜、时间线、延迟队列、统计等多种应用场景。

**核心优势**:
- ✅ 功能完整：实现了所有常用 Redis 命令
- ✅ 类型安全：支持泛型，自动类型转换
- ✅ 统一封装：所有操作统一通过 `BoundUtil` 访问
- ✅ 原子性保证：关键操作使用 Lua 脚本
- ✅ 性能优化：使用增量更新、批量操作等优化
- ✅ 应用丰富：覆盖多种实际业务场景



