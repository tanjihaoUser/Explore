<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wait.mapper.CommentMapper">

    <resultMap id="BaseResultMap" type="com.wait.entity.domain.Comment">
        <id column="id" property="id"/>
        <result column="post_id" property="postId"/>
        <result column="user_id" property="userId"/>
        <result column="parent_id" property="parentId"/>
        <result column="content" property="content"/>
        <result column="like_count" property="likeCount"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <insert id="insert" parameterType="com.wait.entity.domain.Comment" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO post_comment (post_id, user_id, parent_id, content, like_count, is_deleted, created_at, updated_at)
        VALUES (#{postId}, #{userId}, #{parentId}, #{content}, #{likeCount}, #{isDeleted}, #{createdAt}, #{updatedAt})
    </insert>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT id, post_id, user_id, parent_id, content, like_count, is_deleted, created_at, updated_at
        FROM post_comment
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <select id="selectByPostId" resultMap="BaseResultMap">
        SELECT id, post_id, user_id, parent_id, content, like_count, is_deleted, created_at, updated_at
        FROM post_comment
        WHERE post_id = #{postId} AND is_deleted = 0
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="selectTopLevelByPostId" resultMap="BaseResultMap">
        SELECT id, post_id, user_id, parent_id, content, like_count, is_deleted, created_at, updated_at
        FROM post_comment
        WHERE post_id = #{postId} AND (parent_id IS NULL OR parent_id = 0) AND is_deleted = 0
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="selectRepliesByParentId" resultMap="BaseResultMap">
        SELECT id, post_id, user_id, parent_id, content, like_count, is_deleted, created_at, updated_at
        FROM post_comment
        WHERE parent_id = #{parentId} AND is_deleted = 0
        ORDER BY created_at ASC
    </select>

    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT id, post_id, user_id, parent_id, content, like_count, is_deleted, created_at, updated_at
        FROM post_comment
        WHERE user_id = #{userId} AND is_deleted = 0
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <update id="update" parameterType="com.wait.entity.domain.Comment">
        UPDATE post_comment
        <set>
            <if test="content != null">content = #{content},</if>
            <if test="likeCount != null">like_count = #{likeCount},</if>
            <if test="updatedAt != null">updated_at = #{updatedAt},</if>
        </set>
        WHERE id = #{id}
    </update>

    <update id="delete">
        UPDATE post_comment SET is_deleted = 1, updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

    <update id="incrementLikeCount">
        UPDATE post_comment SET like_count = like_count + 1 WHERE id = #{id}
    </update>

    <update id="decrementLikeCount">
        UPDATE post_comment SET like_count = GREATEST(like_count - 1, 0) WHERE id = #{id}
    </update>

    <select id="countByPostId" resultType="int">
        SELECT COUNT(*) FROM post_comment WHERE post_id = #{postId} AND is_deleted = 0
    </select>

    <select id="countByPostIds" resultMap="BaseResultMap">
        SELECT post_id AS postId, COUNT(*) AS likeCount
        FROM post_comment
        WHERE post_id IN
        <foreach collection="postIds" item="postId" open="(" separator="," close=")">
            #{postId}
        </foreach>
        AND is_deleted = 0
        GROUP BY post_id
    </select>

    <!-- 查询所有有评论的帖子ID和评论数（用于定时同步） -->
    <select id="selectAllPostCommentCounts" resultMap="BaseResultMap">
        SELECT post_id AS postId, COUNT(*) AS likeCount
        FROM post_comment
        WHERE is_deleted = 0
        GROUP BY post_id
    </select>

</mapper>

