-- 浏览记录表
-- 用于持久化 Redis 中超过3天的浏览记录
CREATE TABLE IF NOT EXISTS `browse_history` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `user_id` BIGINT NOT NULL COMMENT '用户ID',
    `post_id` BIGINT NOT NULL COMMENT '帖子ID',
    `browse_time` BIGINT NOT NULL COMMENT '浏览时间戳（毫秒）',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_user_post` (`user_id`, `post_id`, `browse_time`),
    KEY `idx_user_id` (`user_id`),
    KEY `idx_user_browse_time` (`user_id`, `browse_time`),
    KEY `idx_post_id` (`post_id`),
    KEY `idx_browse_time` (`browse_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='浏览记录表';

-- 索引说明：
-- uk_user_post: 唯一索引，防止同一用户在同一时间点重复记录同一帖子（虽然业务上不太可能，但作为数据完整性保障）
-- idx_user_id: 用于按用户查询浏览记录
-- idx_user_browse_time: 用于按用户和时间范围查询（复合索引，优化查询性能）
-- idx_post_id: 用于按帖子查询浏览记录（可用于统计帖子被浏览次数）
-- idx_browse_time: 用于按时间范围查询和清理过期数据

-- ============================================
-- Mock 数据：浏览记录
-- ============================================
-- 注意：browse_time 使用时间戳（毫秒），created_at 和 updated_at 由数据库自动处理
-- 这些数据都是超过3天的历史数据，用于测试持久化功能

LOCK TABLES `browse_history` WRITE;
/*!40000 ALTER TABLE `browse_history` DISABLE KEYS */;

-- 用户1的浏览记录（4-7天前）
INSERT INTO `browse_history` (`user_id`, `post_id`, `browse_time`) VALUES
-- 4天前的记录
(1, 1, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000),
(1, 2, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 1000),
(1, 3, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 2000),
(1, 4, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 3000),
(1, 5, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 4000),
-- 5天前的记录
(1, 6, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000),
(1, 7, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 1000),
(1, 8, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 2000),
(1, 9, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 3000),
(1, 10, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 4000),
-- 6天前的记录
(1, 11, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000),
(1, 15, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 1000),
(1, 16, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 2000),
-- 7天前的记录
(1, 20, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000),
(1, 22, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000 + 1000),
(1, 24, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000 + 2000);

-- 用户2的浏览记录（4-7天前）
INSERT INTO `browse_history` (`user_id`, `post_id`, `browse_time`) VALUES
(2, 1, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000),
(2, 3, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 1000),
(2, 5, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 2000),
(2, 7, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 3000),
(2, 9, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 4000),
(2, 17, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000),
(2, 21, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 1000),
(2, 23, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 2000),
(2, 25, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000),
(2, 27, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 1000),
(2, 29, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000),
(2, 35, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000 + 1000);

-- 用户3的浏览记录（4-7天前）
INSERT INTO `browse_history` (`user_id`, `post_id`, `browse_time`) VALUES
(3, 2, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000),
(3, 4, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 1000),
(3, 6, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 2000),
(3, 8, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 3000),
(3, 10, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 4000),
(3, 21, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000),
(3, 22, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 1000),
(3, 23, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 2000),
(3, 24, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000),
(3, 26, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 1000),
(3, 20, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000),
(3, 22, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000 + 1000);

-- 用户4的浏览记录（4-7天前，大量数据用于测试分页）
INSERT INTO `browse_history` (`user_id`, `post_id`, `browse_time`) VALUES
(4, 1, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000),
(4, 2, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 1000),
(4, 3, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 2000),
(4, 4, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 3000),
(4, 5, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 4000),
(4, 6, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 5000),
(4, 7, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 6000),
(4, 8, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 7000),
(4, 9, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 8000),
(4, 10, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 9000),
(4, 15, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000),
(4, 16, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 1000),
(4, 17, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 2000),
(4, 20, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 3000),
(4, 21, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 4000),
(4, 22, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 5000),
(4, 23, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 6000),
(4, 24, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 7000),
(4, 25, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 8000),
(4, 26, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 9000),
(4, 27, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000),
(4, 28, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 1000),
(4, 29, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 2000),
(4, 30, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 3000),
(4, 31, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 4000),
(4, 32, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 5000),
(4, 33, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 6000),
(4, 34, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 7000),
(4, 35, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 8000),
(4, 36, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 9000),
(4, 1, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000),
(4, 2, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000 + 1000),
(4, 3, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000 + 2000),
(4, 4, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000 + 3000),
(4, 5, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000 + 4000);

-- 用户5的浏览记录（4-7天前，测试同一帖子多次浏览）
INSERT INTO `browse_history` (`user_id`, `post_id`, `browse_time`) VALUES
(5, 1, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000),
(5, 1, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 1000),  -- 同一帖子，不同时间
(5, 2, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000),
(5, 2, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 1000),  -- 同一帖子，不同时间
(5, 3, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000),
(5, 27, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 1000),
(5, 28, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 2000),
(5, 29, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000),
(5, 30, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000 + 1000);

-- 用户6的浏览记录（4-7天前）
INSERT INTO `browse_history` (`user_id`, `post_id`, `browse_time`) VALUES
(6, 1, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000),
(6, 3, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 1000),
(6, 5, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 2000),
(6, 7, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 3000),
(6, 16, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000),
(6, 22, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 1000),
(6, 27, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000),
(6, 29, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 1000);

-- 用户7的浏览记录（4-7天前）
INSERT INTO `browse_history` (`user_id`, `post_id`, `browse_time`) VALUES
(7, 2, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000),
(7, 4, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 1000),
(7, 6, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 2000),
(7, 10, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 3000),
(7, 15, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000),
(7, 21, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 1000),
(7, 26, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000),
(7, 35, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 1000);

-- 用户8的浏览记录（4-7天前）
INSERT INTO `browse_history` (`user_id`, `post_id`, `browse_time`) VALUES
(8, 1, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000),
(8, 5, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 1000),
(8, 8, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 2000),
(8, 15, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 3000),
(8, 17, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000),
(8, 23, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 1000),
(8, 28, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000),
(8, 36, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 1000);

-- 用户9的浏览记录（4-7天前）
INSERT INTO `browse_history` (`user_id`, `post_id`, `browse_time`) VALUES
(9, 2, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000),
(9, 7, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 1000),
(9, 10, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 2000),
(9, 20, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000),
(9, 24, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 1000),
(9, 30, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000),
(9, 35, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 1000);

-- 用户10的浏览记录（4-7天前）
INSERT INTO `browse_history` (`user_id`, `post_id`, `browse_time`) VALUES
(10, 1, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000),
(10, 3, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 1000),
(10, 5, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 2000),
(10, 8, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 3000),
(10, 16, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000),
(10, 22, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 1000),
(10, 25, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000),
(10, 29, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 1000);

-- 用户1001的浏览记录（4-7天前）
INSERT INTO `browse_history` (`user_id`, `post_id`, `browse_time`) VALUES
(1001, 31, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000),
(1001, 32, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 1000),
(1001, 33, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 2000),
(1001, 34, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 3000),
(1001, 35, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 4 DAY)) * 1000 + 4000),
(1001, 36, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000),
(1001, 1, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 1000),
(1001, 2, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 5 DAY)) * 1000 + 2000),
(1001, 15, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000),
(1001, 16, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 6 DAY)) * 1000 + 1000),
(1001, 20, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000),
(1001, 24, UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY)) * 1000 + 1000);

/*!40000 ALTER TABLE `browse_history` ENABLE KEYS */;
UNLOCK TABLES;

